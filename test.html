<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  <body>
  </body>
  <script>
class DeepProxy {
  constructor (target, handler) {
    this._preproxy = new WeakMap()
    this._handler = handler
    return this.deepProxy(target, [])
  }

  deepProxy (obj, path) {
    for (let key of Object.keys(obj)) {
      if (typeof obj[key] === 'object') {
        obj[key] = this.deepProxy(obj[key], [...path, key])
      }
    }
    let p = new Proxy(obj, this.makeHandler(path))
    this._preproxy.set(p, obj)
    return p
  }

  deleteProxy (obj, key) {
    if (this._preproxy.has(obj[key])) {
      obj[key] = this._preproxy.get(obj[key])
      this._preproxy.delete(obj[key])
    }
    for (let k of Object.keys(obj[key])) {
      if (typeof obj[key][k] === 'object') {
        this.deleteProxy(obj[key], k)
      }
    }
  }

  makeHandler (path) {
    return {
      set: (target, key, value, receiver) => {
        if (typeof value === 'object') {
          value = this.deepProxy(value, [...path, key])
        }
        target[key] = value
        if (this._handler.set) {
          this._handler.set(target, [...path, key], value, receiver)
        }
        return true
      },
      get: (target, key, value, receiver) => {
        if (!target.hasOwnProperty(key)) {
          target[key] = this.deepProxy({}, [...path, key])
        }
        if (this._handler.get) {
          this._handler.get(target, [...path, key], value, receiver)
        }
        return target[key]
      },
      deleteProperty: (target, key) => {
        if (Reflect.has(target, key)) {
          this.deleteProxy(target, key)
          const deleted = Reflect.deleteProperty(target, key)
          if (deleted && this._handler.deleteProperty) {
            this._handler.deleteProperty(target, [...path, key])
          }
          return deleted
        }
        return false
      }
    }
  }
}

let obj = {
  foo: 'baz',
}


let proxied = new DeepProxy(obj, {
  set(target, path, value, receiver) {
      // console.log('set', path.join('.'), '=', JSON.stringify(value));
      console.log('set value')
  },

  deleteProperty(target, path) {
      console.log('delete', path.join('.'));
  }
});

proxied.foo = 'bar';
proxied.deep = {}
// proxied.deep.blue = 'sea';
// delete proxied.foo;
// delete proxied.deep; // triggers delete on 'deep' but not 'deep.blue'
  </script>
</body>
</html>