<!DOCTYPE html>
<html lang="en">
  <head>
  <!-- so meta -->
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="HandheldFriendly" content="True">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <!-- title -->
  <title>模块化与Webpack原理</title>
  <!-- styles -->
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>
  <body style="background-color: #2d2d2d">
    
      <div class="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <div class="toc-wrap">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#模块化"><span class="toc-number">1.</span> <span class="toc-text">模块化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#什么是模块化"><span class="toc-number">1.1.</span> <span class="toc-text">什么是模块化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JS模块化方案"><span class="toc-number">1.2.</span> <span class="toc-text">JS模块化方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Webpack打包机制"><span class="toc-number">2.</span> <span class="toc-text">Webpack打包机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用webpack打包"><span class="toc-number">2.1.</span> <span class="toc-text">使用webpack打包</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Step1：划分模块，组成模块队列-queue"><span class="toc-number">2.1.1.</span> <span class="toc-text">Step1：划分模块，组成模块队列(queue)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step2：每个模块import和export改写"><span class="toc-number">2.1.2.</span> <span class="toc-text">Step2：每个模块import和export改写</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step3：实现-require-和export逻辑"><span class="toc-number">2.1.3.</span> <span class="toc-text">Step3：实现__require__和export逻辑</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step4：把处理好的模块作为参数传进IIFE"><span class="toc-number">2.1.4.</span> <span class="toc-text">Step4：把处理好的模块作为参数传进IIFE</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#异步加载的模块"><span class="toc-number">2.1.5.</span> <span class="toc-text">异步加载的模块</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编写迷你打包程序"><span class="toc-number">2.2.</span> <span class="toc-text">编写迷你打包程序</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#createAsset"><span class="toc-number">2.2.1.</span> <span class="toc-text">createAsset</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#createGraph"><span class="toc-number">2.2.2.</span> <span class="toc-text">createGraph</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bundle"><span class="toc-number">2.2.3.</span> <span class="toc-text">bundle</span></a></li></ol></li></ol></li></ol>
  </div>
</div>

    
    <div class="layout-content">
      <header class="layout-header">
  <nav class="header-top">
    <ul class="menu">
       
        <li class="menu-item ">
          <a href="/">Home</a>
        </li>
       
        <li class="menu-item ">
          <a href="/archives">Writing</a>
        </li>
       
        <li class="menu-item ">
          <a href="/categories">Category</a>
        </li>
       
        <li class="menu-item ">
          <a href="/about">About</a>
        </li>
      
    </ul>
  </nav>
  
  
    <div class="content">
      <div class="post-header">
        <div class="pic">
          <img src="/images/avatar.jpg" />
        </div>
        <div class="info">
          <div class="title">模块化与Webpack原理</div>
          <div class="post-meta">
            <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
              <span itemprop="name">Yx1aoq1</span>
            </div>
            
  <div class="meta">
    
      <time datetime="2020-06-16T12:50:11.000Z" itemprop="datePublished">2020-06-16</time>
      
    
  </div>

            
	<div class="article-category">
		<i class="fas fa-archive"></i>
		<a class="category-link" href="/categories/Webpack/">Webpack</a>
	</div>


            
	<div class="article-tag">
		<i class="fas fa-tag"></i>
		<a class="tag-link" href="/tags/Webpack/" rel="tag">Webpack</a>
	</div>


          </div>
        </div>
      </div>
    </div>
  
</header>
      <main class="layout-main">
        <article class="content">
  <h2 id="模块化"><a href="#模块化" class="headerlink" title="模块化"></a>模块化</h2><p>早期的 JavaScript 往往作为嵌入到 HTML 页面中的用于控制动画与简单的用户交互的脚本语言，我们习惯这样写：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--html--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"application/javascript"</span>&gt;</span></span><br><span class="line"><span class="actionscript">  <span class="comment">// module1 code</span></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// module2 code</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>所有的嵌入到网页内的 JavaScript 对象都会使用全局的 <code>window</code> 对象来存放未使用 <code>var</code> 定义的变量。这就会导致一个问题，那就是，最后调用的函数或变量取决于我们引入的先后顺序。</p>
<p>随着单页应用与富客户端的流行，不断增长的代码库也急需合理的代码分割与依赖管理的解决方案，这也就是我们在软件工程领域所熟悉的<code>模块化（Modularity）</code>。</p>
<h3 id="什么是模块化"><a href="#什么是模块化" class="headerlink" title="什么是模块化"></a>什么是模块化</h3><blockquote>
<p>简而言之，模块化就是将一个大的功能拆分为多个块，每一个块都是<strong>独立</strong>的，你不需要去担心<strong>污染</strong>全局变量，<strong>命名冲突</strong>什么的。</p>
</blockquote>
<p>模块化的<strong>好处</strong>：</p>
<ul>
<li>封装功能</li>
<li>封闭作用域</li>
<li>可能解决依赖问题</li>
<li>工作效率更高，重构方便</li>
<li>解决命名冲突</li>
<li>…</li>
</ul>
<h3 id="JS模块化方案"><a href="#JS模块化方案" class="headerlink" title="JS模块化方案"></a>JS模块化方案</h3><ul>
<li><strong>全局function模式</strong>：将不同的功能封装成不同的全局函数</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">m1</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">m2</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>问题</strong>：污染全局命名空间，容易引起命名冲突或数据不安全，而且模块成员之间看不出直接关系。</p>
<ul>
<li><strong>namespace模式</strong>：简单对象封装，减少了全局变量，解决命名冲突</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> greeting = &#123;</span><br><span class="line">  helloInLang: &#123;</span><br><span class="line">    en: <span class="string">'Hello world!'</span>,</span><br><span class="line">    es: <span class="string">'¡Hola mundo!'</span>,</span><br><span class="line">    ru: <span class="string">'Привет мир!'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  </span><br><span class="line">  sayHello: <span class="function"><span class="keyword">function</span> (<span class="params">lang</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> helloInLang[lang]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">greeting.helloInLang.en = <span class="string">'hello'</span> <span class="comment">//能直接修改模块内部的数据</span></span><br><span class="line">greeting.sayHello(<span class="string">'en'</span>) <span class="comment">// hello</span></span><br></pre></td></tr></table></figure>

<p><strong>问题</strong>：数据不安全（外部可以直接修改模块内部的数据）。</p>
<ul>
<li><strong>IIFE模式</strong>：匿名函数自调用（闭包），数据是私有的, 外部只能通过暴露的方法操作</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file lib/greeting.js</span></span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">window</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> helloInLang = &#123;</span><br><span class="line">    en: <span class="string">'Hello world!'</span>,</span><br><span class="line">    es: <span class="string">'¡Hola mundo!'</span>,</span><br><span class="line">    ru: <span class="string">'Привет мир!'</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//操作数据的函数</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">sayHello</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">//用于暴露有函数</span></span><br><span class="line">    <span class="keyword">return</span> helloInLang[lang]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">otherFun</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">//内部私有的函数</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'otherFun()'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//暴露行为</span></span><br><span class="line">  <span class="built_in">window</span>.greeting = &#123; sayHello &#125;</span><br><span class="line">&#125;)(<span class="built_in">window</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// index.html文件</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"lib/greeting.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="actionscript">  greeting.sayHello(<span class="string">'en'</span>)</span></span><br><span class="line"><span class="javascript">  <span class="built_in">console</span>.log(greeting.helloInLang) <span class="comment">//undefined 不能访问模块内部数据</span></span></span><br><span class="line"><span class="actionscript">  greeting.helloInLang = <span class="string">'xxxx'</span> <span class="comment">//不是修改的模块内部的helloInLang</span></span></span><br><span class="line"><span class="actionscript">  greeting.sayHello(<span class="string">'en'</span>) <span class="comment">//没有改变</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>问题</strong>：无法解决模块依赖问题。</p>
<ul>
<li><strong>IIFE模式增强</strong>：引入依赖</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file lib/greeting.js</span></span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">window, $</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> helloInLang = &#123;</span><br><span class="line">    en: <span class="string">'Hello world!'</span>,</span><br><span class="line">    es: <span class="string">'¡Hola mundo!'</span>,</span><br><span class="line">    ru: <span class="string">'Привет мир!'</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//操作数据的函数</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">sayHello</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">//用于暴露有函数</span></span><br><span class="line">    $(<span class="string">'body'</span>).css(<span class="string">'background'</span>, <span class="string">'red'</span>)</span><br><span class="line">    <span class="keyword">return</span> helloInLang[lang]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">otherFun</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">//内部私有的函数</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'otherFun()'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//暴露行为</span></span><br><span class="line">  <span class="built_in">window</span>.greeting = &#123; sayHello &#125;</span><br><span class="line">&#125;)(<span class="built_in">window</span>, jQuery)</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// index.html文件</span><br><span class="line"><span class="comment">&lt;!-- 引入的js必须有一定顺序 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"jquery-1.10.1.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"lib/greeting.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="actionscript">  greeting.sayHello(<span class="string">'en'</span>)</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>CommonJS</strong>：主要是应用在Nodejs服务端，属于<strong>动态同步加载</strong>。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file lib/greeting.js</span></span><br><span class="line"><span class="keyword">var</span> helloInLang = &#123;</span><br><span class="line">  en: <span class="string">'Hello world!'</span>,</span><br><span class="line">  es: <span class="string">'¡Hola mundo!'</span>,</span><br><span class="line">  ru: <span class="string">'Привет мир!'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  sayHello: <span class="function"><span class="keyword">function</span> (<span class="params">lang</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> helloInLang[lang]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file hello.js</span></span><br><span class="line"><span class="keyword">const</span> greeting = <span class="built_in">require</span>(<span class="string">'./lib/greeting.js'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> phrase = greeting.sayHello(<span class="string">'en'</span>)</span><br><span class="line"><span class="built_in">document</span>.write(phrase)</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>AMD &amp;&amp; CMD</strong>：AMD是<code>RequireJS</code>提出的，主要是<strong>依赖前置</strong>。CMD是<code>SeaJS</code>提出的，主要是就近依赖（只要用到才会导入），两者用法接近。属于<strong>异步加载</strong>。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file lib/greeting.js</span></span><br><span class="line">define(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> helloInLang = &#123;</span><br><span class="line">    en: <span class="string">'Hello world!'</span>,</span><br><span class="line">    es: <span class="string">'¡Hola mundo!'</span>,</span><br><span class="line">    ru: <span class="string">'Привет мир!'</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    sayHello: <span class="function"><span class="keyword">function</span> (<span class="params">lang</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> helloInLang[lang]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file hello.js</span></span><br><span class="line">define([<span class="string">'./lib/greeting'</span>], <span class="function"><span class="keyword">function</span>(<span class="params">greeting</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> phrase = greeting.sayHello(<span class="string">'en'</span>)</span><br><span class="line">  <span class="built_in">document</span>.write(phrase)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>UMD</strong>：因为AMD中无法使用CommonJS，所以出来了一个UMD，可在UMD中同时使用AMD和CommonJS</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">define</span>) </span>&#123;</span><br><span class="line">  define(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> helloInLang = <span class="string">'hello'</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      sayHello: <span class="function"><span class="keyword">function</span> (<span class="params">lang</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> helloInLang[lang]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;(</span><br><span class="line">	<span class="keyword">typeof</span> <span class="built_in">module</span> === <span class="string">'object'</span> &amp;&amp; <span class="built_in">module</span>.exports &amp;&amp; <span class="keyword">typeof</span> define !==<span class="string">'function'</span></span><br><span class="line">  	? <span class="function"><span class="keyword">function</span> (<span class="params">factory</span>) </span>&#123; <span class="built_in">module</span>.exports = factory() &#125;</span><br><span class="line">  	: define</span><br><span class="line">))</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>ESM（ES Module）</strong>：ES6新规范，JavaScript终于在语言标准的层面上，实现了模块功能，使得在编译时就能确定模块的依赖关系，以及其输入和输出的变量，属于<strong>静态加载（编译时加载）</strong>。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file lib/greeting.js</span></span><br><span class="line"><span class="keyword">const</span> helloInLang = &#123;</span><br><span class="line">  en: <span class="string">'Hello world!'</span>,</span><br><span class="line">  es: <span class="string">'¡Hola mundo!'</span>,</span><br><span class="line">  ru: <span class="string">'Привет мир!'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> sayHello = <span class="function">(<span class="params">lang</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> helloInLang[lang]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file hello.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; sayHello &#125; <span class="keyword">from</span> <span class="string">'./lib/greeting'</span></span><br><span class="line"></span><br><span class="line">sayHello(<span class="string">'en'</span>)</span><br></pre></td></tr></table></figure>

<p><strong>问题</strong>：目前浏览器和Nodejs的支持程度都并不理想，需要使用额外的工具如Babel编译成ES5，才可以在浏览器和Nodejs中运行。</p>
<h2 id="Webpack打包机制"><a href="#Webpack打包机制" class="headerlink" title="Webpack打包机制"></a>Webpack打包机制</h2><p>由于模块化的原因，我们不得不处理不同模块的依赖关系。随着项目越来越庞大，这种关系会变得越来越难以维护。为了方便开发和维护，我们就会使用到打包工具webpack。</p>
<p>webpack可以根据模块的依赖关系进行静态分析，然后将这些模块按照指定的规则生成对应的静态资源。<strong>那么，它究竟是如何处理这些依赖关系的呢</strong>？</p>
<h3 id="使用webpack打包"><a href="#使用webpack打包" class="headerlink" title="使用webpack打包"></a>使用webpack打包</h3><p>新建一个简单的项目，目录下包含这样几个文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">src</span><br><span class="line"> ├── big.js</span><br><span class="line"> ├── helloWorld.js</span><br><span class="line"> ├── index.js</span><br><span class="line"> └── lazy.js</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">import</span> helloWorld <span class="keyword">from</span> <span class="string">'./helloWorld'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> node = <span class="built_in">document</span>.createElement(<span class="string">"div"</span>) </span><br><span class="line">node.innerHTML = helloWorld + <span class="string">'loading...'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span>(<span class="comment">/* webpackChunkName: "async" */</span> <span class="string">'./lazy'</span>)</span><br><span class="line">  .then(<span class="function">(<span class="params">&#123; <span class="keyword">default</span>: lazy &#125;</span>) =&gt;</span> &#123;     </span><br><span class="line">    node.innerHTML = helloWorld + lazy     </span><br><span class="line">  &#125;) </span><br><span class="line"></span><br><span class="line"><span class="built_in">document</span>.body.appendChild(node)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// helloWorld.js</span></span><br><span class="line"><span class="keyword">import</span> big <span class="keyword">from</span> <span class="string">'./big'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> helloWorld = big(<span class="string">'hello world!'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> helloWorld</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lazy.js</span></span><br><span class="line"><span class="keyword">import</span> big <span class="keyword">from</span> <span class="string">'./big'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> lazy = big(<span class="string">"lazy loaded!"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> lazy</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// big.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (val) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> val &amp;&amp; val.toUpperCase()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Step1：划分模块，组成模块队列-queue"><a href="#Step1：划分模块，组成模块队列-queue" class="headerlink" title="Step1：划分模块，组成模块队列(queue)"></a>Step1：划分模块，组成模块队列(queue)</h4><p>从以上代码中我们可以观察到每个模块之间的引用关系：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">* src&#x2F;index.js (ESM)</span><br><span class="line">  # .&#x2F;helloWorld</span><br><span class="line">  # (async) .&#x2F;lazy</span><br><span class="line">  - src&#x2F;helloWorld.js</span><br><span class="line">  - (async) src&#x2F;lazy.js</span><br><span class="line">* src&#x2F;helloWorld.js (ESM)</span><br><span class="line">  # .&#x2F;big</span><br><span class="line">  - src&#x2F;big.js</span><br><span class="line">* src&#x2F;big.js</span><br><span class="line">* src&#x2F;lazy.js (ESM)</span><br><span class="line">  # .&#x2F;big</span><br><span class="line">  - src&#x2F;big.js</span><br></pre></td></tr></table></figure>

<img src="https://images-1300309047.cos.ap-chengdu.myqcloud.com/blog/webpack-module-3.png" style="zoom:33%;" />

<p>使用webpack打包后的结果：</p>
<p><img src="https://images-1300309047.cos.ap-chengdu.myqcloud.com/blog/webpack-module-2.png" alt=""></p>
<p>我们可以观察一下打包生成的<code>main.js</code>里的内容，这里的代码比我们的源代码多了许多乱七八糟的东西，但是我们可以将它简化：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/******/</span> (<span class="function"><span class="keyword">function</span>(<span class="params">modules</span>) </span>&#123; <span class="comment">// webpackBootstrap</span></span><br><span class="line"><span class="comment">/*中间部分删减*/</span></span><br><span class="line"><span class="comment">/******/</span> &#125;)</span><br><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line"><span class="comment">/******/</span> (&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***/</span> <span class="string">"./src/big.js"</span>:</span><br><span class="line"><span class="comment">/***/</span> (<span class="function"><span class="keyword">function</span>(<span class="params">module, __webpack_exports__, __webpack_require__</span>) </span>&#123;</span><br><span class="line"><span class="comment">/*中间部分删减*/</span></span><br><span class="line"><span class="comment">/***/</span> &#125;),</span><br><span class="line"></span><br><span class="line"><span class="comment">/***/</span> <span class="string">"./src/index.js"</span>:</span><br><span class="line"><span class="comment">/***/</span> (<span class="function"><span class="keyword">function</span>(<span class="params">module, __webpack_exports__, __webpack_require__</span>) </span>&#123;</span><br><span class="line"><span class="comment">/*中间部分删减*/</span></span><br><span class="line"><span class="comment">/***/</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">/******/</span> &#125;);</span><br></pre></td></tr></table></figure>

<p>简化后我们可以发现，<code>main.js</code>里的内容本质上是一个立即执行函数，这个函数的参数便是我们模块代码（队列）：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">modules</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 模块串联逻辑</span></span><br><span class="line">&#125;)(&#123;</span><br><span class="line">  <span class="comment">// 所有的模块对象</span></span><br><span class="line">  [moduleId]: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="comment">/* code... */</span> &#125;</span><br><span class="line">  <span class="comment">// 更多`模块-id键值`对</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="Step2：每个模块import和export改写"><a href="#Step2：每个模块import和export改写" class="headerlink" title="Step2：每个模块import和export改写"></a>Step2：每个模块import和export改写</h4><p>由于在webpack中配置了<code>concatenateModules: true</code>（作用域提升），<code>index.js</code>与<code>helloWorld.js</code>模块合并成了一个文件。查看<code>模块-id键值</code>中的function内容可以发现，webpack对模块内的import与export进行了改写：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// big.js</span></span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">__require__, exports</span>) </span>&#123;</span><br><span class="line">  exports.default = <span class="function">(<span class="params">val</span>) =&gt;</span> &#123;</span><br><span class="line">     <span class="keyword">return</span> val &amp;&amp; val.toUpperCase() </span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js + helloWorld.js</span></span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">__require__, exports</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> big = __require__(<span class="string">'./src/big.js'</span>)</span><br><span class="line">  <span class="keyword">const</span> helloWorld = big.default(<span class="string">'hello world'</span>)</span><br><span class="line">  <span class="keyword">const</span> node = <span class="built_in">document</span>.createElement(<span class="string">"div"</span>) </span><br><span class="line">  node.innerHTML = helloWorld + <span class="string">'loading...'</span></span><br><span class="line">  <span class="comment">// 先看普通的import</span></span><br><span class="line">  <span class="comment">// import(/* webpackChunkName: "async" */ './lazy')</span></span><br><span class="line">  <span class="comment">//   .then((&#123; default: lazy &#125;) =&gt; &#123;     </span></span><br><span class="line">  <span class="comment">//     node.innerHTML = helloWorld + lazy     </span></span><br><span class="line">  <span class="comment">//   &#125;) </span></span><br><span class="line">  <span class="built_in">document</span>.body.appendChild(node)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lazy.js</span></span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">__require__, exports</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> big = __require__(<span class="string">'./src/big.js'</span>)</span><br><span class="line">  <span class="keyword">const</span> lazy = big.default(<span class="string">'lazy loaded!'</span>)</span><br><span class="line">  exports.default = lazy</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="Step3：实现-require-和export逻辑"><a href="#Step3：实现-require-和export逻辑" class="headerlink" title="Step3：实现__require__和export逻辑"></a>Step3：实现__require__和export逻辑</h4><p>我们知道import需要具备以下功能：</p>
<ul>
<li>执行目标模块代码</li>
<li>导出目标模块的export内容给外部使用</li>
</ul>
<p>因此<code>__require__</code>与<code>export</code>需要具备以上功能，使代码能在单文件中相互引用并执行：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">!(<span class="function"><span class="keyword">function</span> (<span class="params">modules</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__require__</span> (<span class="params">id</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 设置一个缓存，有的话直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (cache[id]) <span class="keyword">return</span> cache[id].exports</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> <span class="built_in">module</span> = &#123;</span><br><span class="line">      exports: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 1.执行当前模块的内容，这个modules[id]就是我们之前对每个模块封装后的代码</span></span><br><span class="line">    modules[id](__require__, <span class="built_in">module</span>.exports, <span class="built_in">module</span>)</span><br><span class="line">    cache[id] = <span class="built_in">module</span></span><br><span class="line">    <span class="comment">// 2.导出当前模块的export内容给外部使用</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">module</span>.exports</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)(&#123;</span><br><span class="line">  <span class="comment">// [moduleId]: function () &#123;&#125;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="Step4：把处理好的模块作为参数传进IIFE"><a href="#Step4：把处理好的模块作为参数传进IIFE" class="headerlink" title="Step4：把处理好的模块作为参数传进IIFE"></a>Step4：把处理好的模块作为参数传进IIFE</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">!(<span class="function"><span class="keyword">function</span> (<span class="params">modules</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__require__</span> (<span class="params">id</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 设置一个缓存，有的话直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (cache[id]) <span class="keyword">return</span> cache[id].exports</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> <span class="built_in">module</span> = &#123;</span><br><span class="line">      exports: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 1.执行当前模块的内容，这个modules[id]就是我们之前对每个模块封装后的代码</span></span><br><span class="line">    modules[id](__require__, <span class="built_in">module</span>.exports, <span class="built_in">module</span>)</span><br><span class="line">    cache[id] = <span class="built_in">module</span></span><br><span class="line">    <span class="comment">// 2.导出当前模块的export内容给外部使用</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">module</span>.exports</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)(&#123;</span><br><span class="line">  <span class="string">'./src/big.js'</span>: (<span class="function"><span class="keyword">function</span> (<span class="params">__require__, exports</span>) </span>&#123;</span><br><span class="line">    exports.default = <span class="function">(<span class="params">val</span>) =&gt;</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> val &amp;&amp; val.toUpperCase() </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;),</span><br><span class="line">  <span class="string">'./src/index.js'</span>: (<span class="function"><span class="keyword">function</span> (<span class="params">__require__, exports</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> big = __require__(<span class="string">'./src/big.js'</span>)</span><br><span class="line">    <span class="keyword">const</span> helloWorld = big.default(<span class="string">'hello world'</span>)</span><br><span class="line">    <span class="keyword">const</span> node = <span class="built_in">document</span>.createElement(<span class="string">"div"</span>) </span><br><span class="line">    node.innerHTML = helloWorld + <span class="string">'loading...'</span></span><br><span class="line">    <span class="comment">// 先看普通的import</span></span><br><span class="line">    <span class="comment">// import(/* webpackChunkName: "async" */ './lazy')</span></span><br><span class="line">    <span class="comment">//   .then((&#123; default: lazy &#125;) =&gt; &#123;     </span></span><br><span class="line">    <span class="comment">//     node.innerHTML = helloWorld + lazy     </span></span><br><span class="line">    <span class="comment">//   &#125;) </span></span><br><span class="line">    <span class="built_in">document</span>.body.appendChild(node)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="异步加载的模块"><a href="#异步加载的模块" class="headerlink" title="异步加载的模块"></a>异步加载的模块</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__require__.loadChunk(<span class="string">'async'</span>) <span class="comment">// 请求lazy.js的内容</span></span><br><span class="line">  .then(__require__.bind(<span class="literal">null</span>, <span class="string">'./src/lazy.js'</span>)) <span class="comment">// 请求完毕后将模块 require 进去</span></span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span> (<span class="params">_ref</span>) </span>&#123; <span class="comment">// 执行代码内容</span></span><br><span class="line">    <span class="keyword">var</span> lazy = _ref.default</span><br><span class="line">    node.innerHTML = helloWorld + lazy</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 请求部分，loadChunk的实现</span></span><br><span class="line"><span class="keyword">let</span> chunkResolves = &#123;&#125;</span><br><span class="line"></span><br><span class="line">__require__.loadChunk = <span class="function"><span class="keyword">function</span> (<span class="params">chunkId</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span> (<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    chunkResolves[chunkId] = resolve</span><br><span class="line">    <span class="keyword">let</span> srcipt = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>)</span><br><span class="line">    script.src = <span class="string">'src/'</span> + chunkId + <span class="string">'.js'</span></span><br><span class="line">    <span class="built_in">document</span>.head.appendChild(script)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 得到callback()数据包</span></span><br><span class="line"><span class="built_in">window</span>.webpackJsonpCallback (<span class="string">'async'</span>, &#123;</span><br><span class="line">  <span class="string">'./src/lazy.js'</span>: (<span class="function"><span class="keyword">function</span> (<span class="params">__require__, exports</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> big = __require__(<span class="string">'./src/big.js'</span>)</span><br><span class="line">    <span class="keyword">const</span> lazy = big.default(<span class="string">'lazy loaded!'</span>)</span><br><span class="line">    exports.default = lazy</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 每个模块下载(promise)完成对应的resolve</span></span><br><span class="line"><span class="keyword">let</span> chunkResolves = &#123;&#125;</span><br><span class="line"><span class="built_in">window</span>.webpackJsonpCallback = <span class="function"><span class="keyword">function</span> (<span class="params">chunkId, newModules</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> id <span class="keyword">in</span> newModules) &#123;</span><br><span class="line">    modules[id] = newModules[id]</span><br><span class="line">    chunkResolves[chunkId]()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="编写迷你打包程序"><a href="#编写迷你打包程序" class="headerlink" title="编写迷你打包程序"></a>编写迷你打包程序</h3><p>了解了webpack的打包步骤，我们可以模拟以上过程编写出完整的代码。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 打包程序所需要的主要模块功能</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析模块</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createAsset</span> (<span class="params">filename</span>) </span>&#123;&#125;</span><br><span class="line"><span class="comment">// 生成依赖图</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createGraph</span> (<span class="params">entry</span>) </span>&#123;&#125;</span><br><span class="line"><span class="comment">// 打包</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bundle</span> (<span class="params">graph</span>) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> graph = createGraph(<span class="string">'./src/index.js'</span>)</span><br><span class="line"><span class="keyword">const</span> result = bundle(graph)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(result)</span><br></pre></td></tr></table></figure>

<p>所需依赖工具：</p>
<ul>
<li>@babel/parser：js解析器，将文本代码转化成AST（语法树）</li>
<li>@babel/traverse：遍历AST寻找依赖关系</li>
<li>@babel/core的transformFromAst：将AST代码转化成浏览器所能识别的代码（ES5）</li>
</ul>
<h4 id="createAsset"><a href="#createAsset" class="headerlink" title="createAsset"></a>createAsset</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createAsset</span> (<span class="params">filename</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 读取文件</span></span><br><span class="line">  <span class="keyword">const</span> content = fs.readFileSync(filename, <span class="string">'utf-8'</span>)</span><br><span class="line">  <span class="comment">// 我们通过 babylon 这个 javascript 解析器来理解 import 进来的字符串 </span></span><br><span class="line">  <span class="keyword">const</span> ast = parser.parse(content, &#123;</span><br><span class="line">    sourceType: <span class="string">'module'</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// 该模块所依赖的模块的相对路径</span></span><br><span class="line">  <span class="keyword">const</span> dependencies = []</span><br><span class="line">  <span class="comment">// import声明 </span></span><br><span class="line">  traverse(ast, &#123;</span><br><span class="line">    ImportDeclaration: <span class="function">(<span class="params">&#123; node &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      dependencies.push(node.source.value)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// 递增设置模块ID </span></span><br><span class="line">  <span class="keyword">const</span> id = ID++</span><br><span class="line">  <span class="comment">// AST -&gt; ES5</span></span><br><span class="line">  <span class="keyword">const</span> &#123; code &#125; = transformFromAst(ast, <span class="literal">null</span>, &#123;</span><br><span class="line">    presets: [<span class="string">'@babel/env'</span>],</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    id,</span><br><span class="line">    filename,</span><br><span class="line">    dependencies,</span><br><span class="line">    code</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="createGraph"><a href="#createGraph" class="headerlink" title="createGraph"></a>createGraph</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createGraph</span> (<span class="params">entry</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 从第一个文件开始,首先解析index文件 </span></span><br><span class="line">  <span class="keyword">const</span> mainAsset = createAsset(entry)</span><br><span class="line">  <span class="comment">// 定义一个依赖队列，一开始的时候只有入口文件 </span></span><br><span class="line">  <span class="keyword">const</span> queue = [mainAsset]</span><br><span class="line">  <span class="comment">// 遍历 queue，广度优</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> asset <span class="keyword">of</span> queue) &#123;</span><br><span class="line">    asset.mapping = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> dirname = path.dirname(asset.filename)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历依赖数组，解析每一个依赖模块</span></span><br><span class="line">    asset.dependencies.forEach(<span class="function"><span class="params">relativePath</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> absolutePath = path.join(dirname, relativePath) + <span class="string">'.js'</span></span><br><span class="line">      <span class="comment">// 解析</span></span><br><span class="line">      <span class="keyword">const</span> child = createAsset(absolutePath)</span><br><span class="line">      <span class="comment">// 子模块`路径-id`map</span></span><br><span class="line">      asset.mapping[relativePath] = child.id</span><br><span class="line">      queue.push(child)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> queue</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="bundle"><a href="#bundle" class="headerlink" title="bundle"></a>bundle</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bundle</span> (<span class="params">graph</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> modules = <span class="string">''</span></span><br><span class="line">  graph.forEach(<span class="function"><span class="params">mod</span> =&gt;</span> &#123;</span><br><span class="line">    modules += <span class="string">`<span class="subst">$&#123;mod.id&#125;</span>: [</span></span><br><span class="line"><span class="string">      function (require, module, exports) &#123;</span></span><br><span class="line"><span class="string">        <span class="subst">$&#123;mod.code&#125;</span></span></span><br><span class="line"><span class="string">      &#125;,</span></span><br><span class="line"><span class="string">      <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(mod.mapping)&#125;</span></span></span><br><span class="line"><span class="string">    ],`</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">const</span> result = <span class="string">`</span></span><br><span class="line"><span class="string">(function (modules) &#123;</span></span><br><span class="line"><span class="string">  function require(id) &#123;</span></span><br><span class="line"><span class="string">    const [fn, mapping] = modules[id]</span></span><br><span class="line"><span class="string">    function localRequire (name) &#123;</span></span><br><span class="line"><span class="string">      return require(mapping[name])</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    const module = &#123; exports: &#123;&#125; &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    fn(localRequire, module, module.exports)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    return module.exports</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  require(0)</span></span><br><span class="line"><span class="string">&#125;)(&#123;</span></span><br><span class="line"><span class="string">  <span class="subst">$&#123;modules&#125;</span></span></span><br><span class="line"><span class="string">&#125;)</span></span><br><span class="line"><span class="string">  `</span></span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>项目地址：<a href="https://github.com/Yx1aoq1/mini-pack" target="_blank" rel="noopener">mini-pack</a></p>
<p>参考文章：</p>
<ul>
<li><a href="https://segmentfault.com/a/1190000011081338" target="_blank" rel="noopener">JavaScript模块化开发的演进历程</a></li>
<li><a href="https://juejin.im/post/5c17ad756fb9a049ff4e0a62#heading-55" target="_blank" rel="noopener">前端模块化详解(完整版)</a></li>
<li><a href="https://juejin.im/post/5b67c342e51d45172832123d#heading-4" target="_blank" rel="noopener">你真的懂模块化吗？教你CommonJS实现</a></li>
<li><a href="https://github.com/airuikun/blog/issues/4" target="_blank" rel="noopener">webpack工程化打包原理解析与实现</a></li>
</ul>

</article>
<div class="prev-or-next">
  <div class="post-foot-next">
    
      <a href="/2020/06/15/%E7%AE%97%E6%B3%95/%E3%80%90%E7%AE%97%E6%B3%95%E3%80%91%E5%A4%8D%E6%9D%82%E5%BA%A6%E8%AE%A1%E7%AE%97/" target="_self">
        <i class="fas fa-angle-left"></i>
        <span>Previous post</span>
      </a>
    
  </div>
  <div class="post-foot-prev">
    
      <a href="/2020/06/18/%E7%AE%97%E6%B3%95/%E3%80%90%E7%AE%97%E6%B3%95%E3%80%91%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95%E6%80%BB%E7%BB%93/" target="_self">
        <span>Next post</span>
        <i class="fas fa-angle-right"></i>
      </a>
    
  </div>
</div>
      </main>
      <footer class="layout-footer">
  <div>
    Copyright &copy;
    
    
    2025
    Yx1aoq1
  </div>
</footer>
    </div>
    <!-- styles -->
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/js/accordion-menu.js"></script>

  </body>
</html>
